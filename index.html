<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gama Seguridad - Gesti√≥n de Cobranza</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f0f2f5; color: #333; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { 
            background: #1a365d; 
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { font-size: 24px; }
        .logo { height: 50px; }

        /* Login */
        #login-screen {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }
        .login-box input {
            width: 100%;
            padding: 14px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .btn {
            background: #1a365d;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
        }
        .btn:hover { background: #2d4a7c; }
        .error { color: #e53e3e; font-weight: bold; margin-top: 15px; display: none; }

        /* Upload Area */
        .upload-area {
            border: 3px dashed #1a365d;
            padding: 60px 20px;
            text-align: center;
            border-radius: 12px;
            background: white;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .upload-area:hover { border-color: #2d4a7c; background: #f8fafc; }
        .upload-area h3 { color: #1a365d; margin-bottom: 15px; }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;
        }
        .card h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
        .card .value { font-size: 28px; font-weight: 700; color: #1a365d; }
        .card.pagado .value { color: #38a169; }
        .card.pendiente .value { color: #dd6b20; }
        .card.vencido .value { color: #e53e3e; }

        /* Alerts Panel */
        .alerts-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 20px;
            margin: 30px 0;
            border-left: 4px solid #e53e3e;
        }
        .alerts-panel h3 { color: #1a365d; margin-bottom: 15px; }
        .alert-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .alert-item:last-child { border-bottom: none; }

        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
            margin: 30px 0;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px 12px; text-align: left; border-bottom: 1px solid #eee; }
        th {
            background: #f8fafc;
            font-weight: 600;
            color: #1a365d;
            cursor: pointer;
        }
        tr:hover { background: #f8fafc; }
        .status-pendiente { color: #dd6b20; font-weight: 600; }
        .status-vencido { color: #e53e3e; font-weight: 600; }
        .status-pagado { color: #38a169; font-weight: 600; }

        /* Responsive */
        @media (max-width: 768px) {
            .summary-cards { grid-template-columns: 1fr; }
            th, td { padding: 12px 8px; font-size: 14px; }
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <h2>üîê Acceso a Gama Seguridad</h2>
        <input type="text" id="username" placeholder="Usuario" value="ecarrasco">
        <input type="password" id="password" placeholder="Contrase√±a" value="ecarrasco2309">
        <button class="btn" onclick="login()">Iniciar Sesi√≥n</button>
        <div id="login-error" class="error">‚ùå Usuario o contrase√±a incorrectos</div>
    </div>

    <!-- MAIN SYSTEM (oculto hasta login) -->
    <div id="main-system" class="container" style="display: none;">
        <header>
            <h1>Gesti√≥n de Cobranza - Gama Seguridad</h1>
            <button class="btn" style="padding: 8px 16px; font-size: 14px;" onclick="logout()">Cerrar Sesi√≥n</button>
        </header>

        <div class="upload-area" id="drop-area">
            <h3>üìÅ Arrastra tu archivo Excel (.xlsx) aqu√≠ o haz clic</h3>
            <p>Formato: Columnas ‚Üí "Numero de Factura", "Raz√≥n social", "Fecha de factura", "Fecha de vencimiento", "Monto", "Estado"</p>
        </div>
        <input type="file" id="file-input" accept=".xlsx" style="display: none;">

        <div class="summary-cards">
            <div class="card pagado">
                <h3>TOTAL PAGADO</h3>
                <div class="value" id="total-pagado">0</div>
            </div>
            <div class="card pendiente">
                <h3>TOTAL PENDIENTE</h3>
                <div class="value" id="total-pendiente">0</div>
            </div>
            <div class="card vencido">
                <h3>TOTAL VENCIDO</h3>
                <div class="value" id="total-vencido">0</div>
            </div>
            <div class="card">
                <h3>% MOROSIDAD</h3>
                <div class="value" id="morosidad">0%</div>
            </div>
        </div>

        <div class="alerts-panel">
            <h3>üîî Pr√≥ximas Llamadas</h3>
            <div id="alerts-list">
                <div class="alert-item">
                    <div>Sin llamadas programadas</div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>N¬∞ Factura</th>
                        <th>Raz√≥n Social</th>
                        <th>Fecha Factura</th>
                        <th>Fecha Vencimiento</th>
                        <th>Monto</th>
                        <th>Estado</th>
                        <th>Pr√≥xima Llamada</th>
                        <th>Prioridad</th>
                        <th>Notas</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Aqu√≠ aparecer√°n los datos cuando subas el Excel -->
                </tbody>
            </table>
        </div>

        <button class="btn" id="download-btn" disabled style="margin: 30px 0;">‚¨áÔ∏è Descargar Excel Actualizado</button>
    </div>

    <script>
        // LOGIN
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            // Usuarios v√°lidos
            if ((username === 'admin@admin.com' && password === '123456789') || 
                (username === 'ecarrasco' && password === 'ecarrasco2309')) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-system').style.display = 'block';
            } else {
                document.getElementById('login-error').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('login-error').style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            document.getElementById('main-system').style.display = 'none';
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('table-body').innerHTML = '';
            document.getElementById('alerts-list').innerHTML = '<div class="alert-item"><div>Sin llamadas programadas</div></div>';
        }

        // FILE UPLOAD
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');

        dropArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', handleFile);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.style.borderColor = '#2d4a7c';
            dropArea.style.background = '#f0f4ff';
        }

        function unhighlight() {
            dropArea.style.borderColor = '#1a365d';
            dropArea.style.background = 'white';
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                handleFile({ target: { files } });
            }
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    let jsonData = XLSX.utils.sheet_to_json(worksheet);

                    // Validar columnas
                    const requiredCols = ['Numero de Factura', 'Raz√≥n social', 'Fecha de factura', 'Fecha de vencimiento', 'Monto', 'Estado'];
                    const missingCols = requiredCols.filter(col => !jsonData[0] || !(col in jsonData[0]));
                    if (missingCols.length > 0) {
                        alert('‚ùå Error: Faltan columnas: ' + missingCols.join(', '));
                        return;
                    }

                    // Procesar datos
                    const hoy = new Date();
                    hoy.setHours(0,0,0,0);

                    jsonData = jsonData.map(row => {
                        // Convertir fechas
                        row['Fecha de factura'] = parseDate(row['Fecha de factura']);
                        row['Fecha de vencimiento'] = parseDate(row['Fecha de vencimiento']);
                        row['Fecha de Pago'] = row['Fecha de Pago'] ? parseDate(row['Fecha de Pago']) : '';

                        // Monto sin decimales
                        row['Monto'] = parseInt(parseFloat(row['Monto'])) || 0;

                        // Estado
                        if (row['Estado'] !== 'Pagado') {
                            const fechaVenc = new Date(row['Fecha de vencimiento']);
                            if (fechaVenc < hoy) {
                                row['Estado'] = 'Vencido';
                            } else {
                                row['Estado'] = 'Pendiente';
                            }
                        }

                        // Prioridad y pr√≥xima llamada
                        if (row['Estado'] === 'Vencido') {
                            row['Prioridad'] = 'Alta';
                            row['Pr√≥xima Llamada'] = new Date(hoy.getTime() + 86400000).toISOString().split('T')[0]; // Ma√±ana
                        } else if (row['Estado'] === 'Pendiente') {
                            const fechaVenc = new Date(row['Fecha de vencimiento']);
                            const diasHastaVencimiento = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                            if (diasHastaVencimiento <= 3) {
                                row['Prioridad'] = 'Media';
                                row['Pr√≥xima Llamada'] = new Date(hoy.getTime() + 86400000).toISOString().split('T')[0]; // Ma√±ana
                            } else {
                                row['Prioridad'] = 'Baja';
                                row['Pr√≥xima Llamada'] = '';
                            }
                        } else {
                            row['Prioridad'] = 'Baja';
                            row['Pr√≥xima Llamada'] = '';
                        }

                        // Notas (√∫ltima columna si existe)
                        row['Notas'] = row['Notas'] || '';

                        return row;
                    });

                    // Renderizar tabla
                    renderTable(jsonData);
                    updateSummary(jsonData);
                    updateAlerts(jsonData);

                    // Guardar para descargar
                    window.cobranzaData = jsonData;

                    // Habilitar bot√≥n de descarga
                    document.getElementById('download-btn').disabled = false;

                } catch (err) {
                    alert('‚ùå Error al procesar el archivo: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseDate(dateStr) {
            if (!dateStr) return '';
            if (dateStr instanceof Date) return formatDate(dateStr);
            if (typeof dateStr === 'string') {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return formatDate(date);
                }
            }
            return String(dateStr);
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function renderTable(data) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['Numero de Factura']}</td>
                    <td>${row['Raz√≥n social']}</td>
                    <td>${row['Fecha de factura']}</td>
                    <td>${row['Fecha de vencimiento']}</td>
                    <td>${formatNumber(row['Monto'])}</td>
                    <td class="status-${row['Estado'].toLowerCase()}">${row['Estado']}</td>
                    <td>${row['Pr√≥xima Llamada'] || ''}</td>
                    <td>${row['Prioridad']}</td>
                    <td>${row['Notas']}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function updateSummary(data) {
            const totalPagado = data.filter(r => r['Estado'] === 'Pagado').reduce((sum, r) => sum + r['Monto'], 0);
            const totalPendiente = data.filter(r => r['Estado'] === 'Pendiente').reduce((sum, r) => sum + r['Monto'], 0);
            const totalVencido = data.filter(r => r['Estado'] === 'Vencido').reduce((sum, r) => sum + r['Monto'], 0);
            const total = totalPagado + totalPendiente + totalVencido;
            const morosidad = total > 0 ? ((totalVencido / total) * 100).toFixed(1) : 0;

            document.getElementById('total-pagado').textContent = formatNumber(totalPagado);
            document.getElementById('total-pendiente').textContent = formatNumber(totalPendiente);
            document.getElementById('total-vencido').textContent = formatNumber(totalVencido);
            document.getElementById('morosidad').textContent = `${morosidad}%`;
        }

        function updateAlerts(data) {
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = '';

            const today = new Date();
            today.setHours(0,0,0,0);

            const upcomingCalls = data
                .filter(r => r['Pr√≥xima Llamada'] && r['Prioridad'] === 'Alta')
                .map(r => ({
                    fecha: r['Pr√≥xima Llamada'],
                    cliente: r['Raz√≥n social'],
                    factura: r['Numero de Factura']
                }))
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            if (upcomingCalls.length === 0) {
                alertsList.innerHTML = '<div class="alert-item"><div>Sin llamadas programadas</div></div>';
                return;
            }

            upcomingCalls.forEach(call => {
                const div = document.createElement('div');
                div.className = 'alert-item';
                div.innerHTML = `
                    <div><strong>${call.cliente}</strong> (${call.factura})</div>
                    <div><small>${call.fecha}</small></div>
                `;
                alertsList.appendChild(div);
            });
        }

        // DOWNLOAD EXCEL
        document.getElementById('download-btn').addEventListener('click', () => {
            if (!window.cobranzaData) return;

            const exportData = window.cobranzaData.map(row => ({
                'Numero de Factura': row['Numero de Factura'],
                'Raz√≥n social': row['Raz√≥n social'],
                'Fecha de factura': row['Fecha de factura'],
                'Fecha de vencimiento': row['Fecha de vencimiento'],
                'Monto': row['Monto'],
                'Estado': row['Estado'],
                'Pr√≥xima Llamada': row['Pr√≥xima Llamada'] || '',
                'Prioridad': row['Prioridad'],
                'Notas': row['Notas'] || ''
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Cobranza");
            XLSX.writeFile(wb, "gama_seguridad_cobranza_actualizada.xlsx");
        });
    </script>
</body>
</html>